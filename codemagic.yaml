# .codemagic.yaml
workflows:
  android-build:
    name: Android Build with KSP & Manual Gradle Wrapper Setup
    instance_type: mac_mini_m1
    
    environment:
      vars:
        ANDROID_SDK_LICENSES: true
        JAVA_TOOL_OPTIONS: -Xmx4096m
    
    triggering:
      branch_patterns:
        - pattern: main
          include: true
          
    scripts:
      - name: Make gradlew executable
        script: |
          chmod +x gradlew
          echo "gradlew is now executable."
      
      - name: Download and Prepare Gradle Wrapper
        script: |
          rm -f gradle/wrapper/gradle-wrapper.jar
          rm -rf gradle/wrapper/dists/* if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            echo "ERROR: gradle/wrapper/gradle-wrapper.properties not found!"
            exit 1
          fi
          
          GRADLE_DIST_URL=$(grep '^distributionUrl=' gradle/wrapper/gradle-wrapper.properties | cut -d'=' -f2 | tr -d '\r\n') # Updated grep and tr

          # DEBUG: Print the extracted URL
          echo "DEBUG: Extracted Gradle Distribution URL: '${GRADLE_DIST_URL}'"
          
          GRADLE_VERSION=$(echo "$GRADLE_DIST_URL" | sed -n 's/.*gradle-\([0-9\.]*\)-\(all\|bin\)\.zip/\1/p')
          if [ -z "$GRADLE_VERSION" ]; then
            echo "ERROR: Could not determine Gradle version from distributionUrl in gradle-wrapper.properties."
            exit 1
          fi

          DIST_DIR="gradle/wrapper/dists/gradle-$GRADLE_VERSION-all"
          ZIP_FILE="$DIST_DIR.zip" 

          mkdir -p "$(dirname "$ZIP_FILE")"

          echo "Attempting to download Gradle distribution from: $GRADLE_DIST_URL"
          echo "Downloading to: $ZIP_FILE"

          curl -L -o "$ZIP_FILE" "$GRADLE_DIST_URL"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to download Gradle distribution from $GRADLE_DIST_URL. Curl exit code: $?"
            exit 1
          fi
          
          # Check if the downloaded file size is reasonable (e.g., > 1MB)
          FILE_SIZE=$(du -b "$ZIP_FILE" | cut -f1)
          if [ "$FILE_SIZE" -lt 1000000 ]; then # Check for less than 1MB
            echo "ERROR: Downloaded file size ($FILE_SIZE bytes) is too small. Expected a large ZIP file."
            echo "Content of downloaded file (first 500 bytes):"
            head -c 500 "$ZIP_FILE"
            exit 1
          fi

          echo "Gradle distribution downloaded ($FILE_SIZE bytes). Unpacking to $DIST_DIR..."
          unzip -q "$ZIP_FILE" -d "$(dirname "$DIST_DIR")"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to unpack Gradle distribution to $DIST_DIR. Unzip exit code: $?"
            exit 1
          fi

          rm "$ZIP_FILE"

          echo "Gradle Wrapper setup complete. The gradle-wrapper.jar will be managed by gradlew upon first execution."

      - name: Set Android SDK path
        script: |
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $CM_ENV
          echo "PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools" >> $CM_ENV
          echo "Android SDK paths set."
      
      - name: Clean Project
        script: |
          ./gradlew clean
          echo "Project cleaned successfully."
      
      - name: Build Android Debug APK
        script: |
          ./gradlew assembleDebug
          echo "Debug APK build complete."
          
    artifacts:
      - app/build/outputs/**/*.apk
      - app/build/outputs/**/*.aab
      
    publishing:
      email:
        recipients:
          - deine.email@example.com
